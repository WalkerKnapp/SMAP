SimulateSites is a localization based simulation engine for SMAP. It 
uses as an input a list of localizations, a matlab function that
returns coordiantes or an image which defines a 2D structure. It 
returns simulated localizations to SMAP using a realistic model for the 
photophysics of the dye. Simulated structures are added to the RoiManager.

Algorithm:

1. Generate ground truth (GT) positions for proteins. These are directly generated by a model function. If Tiff images or 
volumes are used, then the labeling density parameter is used to randomly place proteins into the ROI with a density 
proportional to the image pixel value.

2. A linkage error is added to the position of the protein (random variable from a normal distribution 
in x, y, and z).

3. Proteins are converted into fluorophores taking into account a limited labeling efficiency.

4. The frame in which the fluorophore is activated the first time is drawn from a random number.

5. Fluorophores can be re-activated several times. The number of re-activations is
drawn from an exponential distribution. SimulateSites has three models for this 
re-activation. 

Simple distributes the re-activations randomly over the simulated frames.
 
PAFP (for photo-activatable fluorescent proteins) has the re-activations occuring within a short time
window after the initial activation (here blinking is due to short-lived dark states).

Dye has the re-actiation occuring after longer times (drawn from an exponential distribution), and with 
every re-activation there is a probability for bleaching.

6. An activation event is distributed across several frames, i.e. a localization. The on-switching occurs randomly within 
a frame and the lifetime is drawn from an exponential distribution.

7. The photons for each localization in each frame are are calculated. 
An intensity is calculated from the mean photons, the lifetime and a random noise modeling camera
read-out noise. The number of photons is drawn from a Poisson distribution with a mean the intensity times
the fraction of the frame the localization is on. 

8. From the number of photons and the background per pixel a localization precision is calculated
based on Mortensen, Nature Methods 2010, 10.1038/nmeth.1447.

9. Each coordinate of each localization is calculated by drawing a random number from a Normal
distribution with a standard deviation equal to the localization precision and adding it to the GT+linkage
error.

10. The simulated localizations are shifted and rotated by random values in a range specified by the user.



gui:Parameters:
gui:EMon If an EM camera is simulated, that results in excess noise.
gui:background Background in photons/pixel/frame
gui:blinks Number of re-activations. Zero means: only one actvation per fluorophore
gui:coordinatefile .txt or .csv file with coordinates, .tif or .png file in which the pixel values are a 
 measure for the concentration of the labels or a matlab function that 
 returns the position of the lables in form of a structure with the fields .x .y .z
gui:labeling_efficiency fraction of target molecules that carry a fluorophore
gui:lifetime average on-time (in frames) of an activated fluorophore
gui:linkageerror Linkage error: this adds a random displacement from a Normal distribution (nm) to the coordiantes.
gui:linkageerrort=linkageerror 
gui:load_button .txt or .csv file with coordinates, .tif or .png file in which the pixel values are a 
 measure for the concentration of the labels or a matlab function that 
 returns the position of the lables in form of a structure with the fields .x .y .z
gui:maxframes Maximum number of frames that contain all localizations
gui:model Select model for blinking: 
 simple: re-activations appear randomly in any frame 
 PAFP: re-activations appear shortly after previous activation 
 Dye: if a dye is not bleached, a re-activation occurs a random time point after the previous one (exponential distribution)
gui:modelt Select model for blinking: 
 simple: re-activations appear randomly in any frame 
 PAFP: re-activations appear shortly after previous activation 
 Dye: if a dye is not bleached, a re-activation occurs a random time point after the previous one (exponential distribution)
gui:numberofsites Number of simulated structures. Pass on two numbers [M N] to generate a grid of MxN structures.
gui:photons mean number of photons emitted by an activated fluorophore before off-switching 
 (this number is distributed among the frames the fluorophore is on).
gui:photonsigma Variance of the photons, modeled by a Normal distribution with standard deviation specified here. 
gui:photonsigmat=photonsigma
gui:randomrot randomly rotate the structures by a maximum angle (degree) defined here. 
 The structures are rotated additionally by a random angle around the z-axis.
gui:randomrotangle randomly rotate the structures by a maximum angle (degree) defined here. 
 The structures are rotated additionally by a random angle around the z-axis.
gui:randomxy Structures are displaced in x,y,z by a random distance
gui:randomxyd Structures are displaced in x,y,z by a random distance
gui:savenow If to save the results in a file. Specify the format. 
gui:savez Also simulate z-coordinate
gui:setModPars_button If a geometric model is loaded, set the parameters here.
gui:t2 Number of re-activations. Zero means: only one actvation per fluorophore
gui:t3 average on-time (in frames) of an activated fluorophore
gui:t4 mean number of photons emitted by an activated fluorophore before off-switching 
 (this number is distributed among the frames the fluorophore is on).
gui:t5 Background in photons/pixel/frame
gui:t6 Number of simulated structures. Pass on two numbers [M N] to generate a grid of MxN structures.
gui:t7 Maximum number of frames that contain all localizations
gui:t_labelingefficiency fraction of target molecules that carry a fluorophore
gui:tif_density density of localizations
gui:tif_imagesize size of the image
gui:tif_imagesizet=tif_imagesize 
gui:tif_numbermode 
gui:useFitter_button 
